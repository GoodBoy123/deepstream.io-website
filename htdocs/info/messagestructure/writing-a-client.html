<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>deepstream.io | Writing a client</title>

	

	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<meta name="keywords" content="deepstream, deepstream.io, streaming, realtime, server, socket" />
	<meta name="description" content="An introduction into how to write a client" />
	<meta name="author" content="Wolfram Hempel" />
	<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
	<link rel="icon" href="/favicon.ico" type="image/x-icon">
	<link rel="stylesheet" type="text/css" href="../../assets/css/navigation.css" />
	<link rel="stylesheet" type="text/css" href="../../assets/css/screen.css" />
	<link rel="stylesheet" type="text/css" href="../../assets/css/api.css" />
	<script type="text/javascript">
	document.createElement( 'header' );
	document.createElement( 'nav' );
	</script>
	<script type="text/javascript" src="../../assets/js/jquery.js"></script>
	<script type="text/javascript" src="../../assets/js/menu.js"></script>
	<script type="text/javascript" src="../../assets/js/prism.js"></script>

	<link href='http://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet' type='text/css'>
	<link href='http://fonts.googleapis.com/css?family=Quicksand:300,400,700' rel='stylesheet' type='text/css'>
	<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
	<link rel="stylesheet" type="text/css" href="../../assets/css/prism.css" />
</head>

<body class="category_info ">
	<div class="mobile-menu">
		<div class="nav mobile-nav">
			<ul>
				<li ><a href="../..">Home</a></li>
				<li ><a href="../../download/">Downloads</a></li>
				<li ><a href="../../tutorials/getting-started.html">Tutorials</a></li>
				<li ><a href="../../docs/deepstream.html">Documentation</a></li>
				<li ><a href="../../blog/">Blog</a></li>
				<li class="active"><a href="../../info/">Info</a></li>
			</ul>		</div>
	</div>

	<div id="outer-wrapper">
		<div id="header" class="compact-header">
			<div class="header-tiny-logo">
				<h1><a href="../..">deepstream.io - a scalable server for realtime web apps</a></h1>
			</div>
			<div class="nav desktop-nav">
				<ul>
					<li ><a href="../..">Home</a></li>
					<li ><a href="../../download/">Downloads</a></li>
					<li ><a href="../../tutorials/getting-started.html">Tutorials</a></li>
					<li ><a href="../../docs/deepstream.html">Documentation</a></li>
					<li ><a href="../../blog/">Blog</a></li>
					<li class="active"><a href="../../info/">Info</a></li>
				</ul>			</div>
			<span class="menu-button menu-icon">
				<i class="fa fa-bars"></i>
			</span>
		</div>
		<div id="wrapper" class="main">
			<ul id="subnav">
	<li class="head first">Performance</li>
	<li >
		<a href="../../info/performance-overview.html">Overview</a>
		<div class="isActiveIndicator orangeGradient"></div>
	</li>	
	<li >
		<a href="../../info/performance-single-node-vs-cluster.html">Single Node vs Cluster</a>
		<div class="isActiveIndicator orangeGradient"></div>
	</li>

	<li class="head first">Message Specification</li>
	<li >
		<a href="../../info/messagestructure/index.html">Overview</a>
		<div class="isActiveIndicator orangeGradient"></div>
	</li>	
	
	<li class="active">
		<a href="../../info/messagestructure/writing-a-client.html">Writing a Client</a>
		<div class="isActiveIndicator orangeGradient"></div>
	</li>	

		<li >
			<a href="../../info/messagestructure/connectivity.html">
			Connectivity Features</a>
			<div class="isActiveIndicator orangeGradient"></div>
		</li>
		<li >
			<a href="../../info/messagestructure/parsing.html">
			Parsing Features</a>
			<div class="isActiveIndicator orangeGradient"></div>
		</li>
		<li >
			<a href="../../info/messagestructure/rpc.html">
			Rpc Features</a>
			<div class="isActiveIndicator orangeGradient"></div>
		</li>
		<li >
			<a href="../../info/messagestructure/records.html">
			Records Features</a>
			<div class="isActiveIndicator orangeGradient"></div>
		</li>
		<li >
			<a href="../../info/messagestructure/events.html">
			Events Features</a>
			<div class="isActiveIndicator orangeGradient"></div>
		</li>
	
	<li >
		<a href="../../info/messagestructure/specs.html">Detailed Specs</a>
		<div class="isActiveIndicator orangeGradient"></div>
	</li>

</ul>

			<div id="content">
				<h1>Writing a Client</h1><p>Writing a deepstream client only requires a TCP connection, basic string manipulation and for convienience a JSON parser/builder if it isn&#39;t supported natively. What this means is that it can run using any programming language and with very basic hardware requirements.</p><p>What we will be covering here are the things to keep in mind when writing a client and an overview on some design approaches.</p><p>I would recommend you to first read how deepstream <a href="./index.html">message structure works</a>.</p><h1>Message Specifications</h1><p>You can now view all the different message structures <a href="./specs.html">here</a> as a reference for all the different messages on the system. If your not sure what a message you recieved means, want to find out if it has an associated ack or want a quick introduction into the low level protocol it&#39;s the perfect place to bookmark.</p><h1>Features</h1><p>Making sure your client works in the exact way the server expects it to can be quite challenging when running against a real server. Because of this, we covered all the features offered using <a href="https://cucumber.io/">cucumber</a>, a format that is supported by most of the popular programming languages.</p><p>What this means is you can test your client continuously while developing it using prewritten integration tests. These tests are continuously run against current clients and when you get them all passing provides the guarantee you&#39;re using the procotol correctly.</p><p>Before reading on, take a quick peek at <a href="./connectivity">the connectivity feature</a> to see how they look like.</p><div class="hint-box fa fa-gears">
    <h3>Hint</h3>
    <ul>
        <li>
            You can hover over messages in features and spec pages to get a breakdown of what they get parsed into.
        </li>
    </ul>
</div>

<p>Since the tests will be run in the language the client is being written in you would also need to setup a very simple TCP server.</p><p>The best place to start would be looking at the <a href="https://raw.githubusercontent.com/hoxton-one/deepstream.io-client-specs/master/step-definitions-server/step-definition-server.js">server step definitions</a> and its <a href="https://raw.githubusercontent.com/hoxton-one/deepstream.io-client-specs/master/step-definitions-server/tcp-server.js">TCP server</a> and applying the same logic in your language of choice.</p><div class="hint-box fa fa-gears">
    <h3>Remember to catch errors</h3>
    <ul>
        <li>
            In order to guarantee no errors are being ignored you can add a <a href="https://github.com/cucumber/cucumber/wiki/Hooks">cucumber hook</a> to run after each feature and ensure no unexpected errors were thrown.
        </li>
    </ul>
</div>

<h1>Connection States</h1><p>Next on is the <a href="../../docs/connection_states.html">connection states</a>. The connection starts off in an AWAITING_AUTHENTICATION mode, in which you are required to login in order to be able to send and recieve messages through the server. Once you do the client should be in AUTHENTICATING, and if the login is successful the connection will end up in OPEN, which means everything is working fine.</p><p>If the connection does drop, clients are expected to go into reconnecting mode to allow them to try and reestablish the connection, in which it can either go back to AWAITING_AUTHENTICATION or result in the client closing after too many failed attempts.</p><p><img width="100%" src="../../assets/images/connection-state-diagram.png" /></p><h1>TCP Buffering</h1><p>Since clients are expected to have a very high throughput it&#39;s good practice to buffer messages within the program and then send it out once at the end of a CPU cycle.</p><p>For example, let us say I have a loop that generates lots of events:</p><pre><code class="lang-javascript">while( i &lt; 10000 ) {
    deepstreamClient.event.emit( &#39;value&#39;, Math.random() );
    i++;
}
</code></pre>
<p>If I was to send the message through directly to the TCP socket for every iteration it would create an overhead having to interact with the socket directly so often. Instead, we can concatenate the messages within the client and then send them in one go. Because of the use of the message seperation character the server can then split the package up and process them in the same order.</p><pre><code class="lang-javascript">connection.prototype.send = function( message ) {
    bufferedSendMessage += message;
    if( !flushTimeout ) {
        flushTimeout = setTimeout( flushMessage );
    }
}
</code></pre>
<p>The same situation happens when you recieve a message. If the traffic is slow you might only be getting one message per packet, but when traffic volumes pickup you will need to split the data recieved and process each message individually.</p><pre><code class="lang-javascript">connection.prototype.recieve = function( message ) {
    var lastMessageSeperator, messages;

    lastMessageSeperator = recievedMessages.lastIndexOf( MESSAGE_SEPERATOR );
    messages = recievedMessages.substring( 0, lastMessageSeperator);
    processMessages( messages );
}
</code></pre>
<h1>Acks</h1><p>Unfortunately timeouts can always occur when internet connections become so slow they might as well not work. Because of this deepstream has ack messages to let the client know the server has recieved the messages sent.</p><p>Ack timeouts are the clients responsibility to keep track of. When a message that can get an associated ack is sent out, you need to set a timer which can be removed once the server replies. If not the application will be notified which depending on the situation can allow you to try the same action again, or notify the user their desired behaviour might not have gone occurred successfully.</p><h1>Unsoliciated Messages</h1><p>Messages recieved that are unexpected should throw an UNSOLICITATED_MESSAGE error. If it occurs often it&#39;s usually a useful indication something might be leaking or not have unsubscribed properly.</p><div class="hint-box fa fa-gears">
    <h3>Edge Case</h3>
    <ul>
        <li>
            In the case of race conditions this could occur if the server sends a message to the client the exact same time it unsubscribed from the message. This can&#39;t be avoided, but should only happen very rarely.
        </li>
    </ul>
</div>

<h1>Errors</h1><p>The last major thing to keep in consideration are error scenarios. If you look at the <a href="../../docs/constants.html#Event">event constants</a> you&#39;ll notice that there are quite a few different unhappy scenarios that may occur. Many of these are expected behaviour, such as MESSAGE_PERMISSION_ERROR or TOO_MANY_AUTH_ATTEMPTS. Others are errors returned by deepsteam incase the message protocol was not correctly used, such as INVALID_MESSAGE_DATA, MESSAGE_PARSE_ERROR or UNKNOWN_TOPIC and some are to expose internal issues, such as CACHE_RETRIEVAL_TIMEOUT or STORAGE_RETRIEVAL_TIMEOUT.</p><p>It&#39;s important to:</p><ul>
<li>Not let the application die when an error occurs</li>
</ul>
<p>Always recover from them as gracefully as possible.</p><ul>
<li>Not swallow errors</li>
</ul>
<p>Errors occur because something went wrong. Having an empty catch statement
is only a stop gap solution and you should always make sure to log the issues that occur</p><ul>
<li>Prevent users from doing things they are not permissioned to</li>
</ul>
<p>If a user is not permissioned to do a certain action it is advisable to stop them from attempting to. Otherwise it could result in inconsistencies on the server where the data was ignored and on the client where the changes either have to be reverted once the MESSAGE_DENIED is recieved or remain out of sync otherwise.</p>
			</div>
		</div>
		<script type="text/javascript" src="../../assets/js/docs.js"></script>
	</div>
	<div id="footer">
		<ul class="footer-items">

			<li class="footer-right">
				<ul class="social">
					<li class="twitter">
						<a href="https://twitter.com/deepstreamIO">
							<i class="fa fa-twitter"></i>  Twitter
						</a>
					</li>
					<li class="github">
						<a href="https://github.com/hoxton-one">
							<i class="fa fa-github"></i>  Github
						</a>
					</li>
					<li class="stack-overflow">
						<a href="http://stackoverflow.com/questions/tagged/deepstream.io">
							<i class="fa fa-stack-overflow"></i>  Stack Overflow
						</a>
					</li>
					<li>
						<a href="https://deepstream-slack.herokuapp.com/">
							<i class="fa fa-slack"></i>  Slack
						</a>
					</li>
				</ul>
			</li>

			<li class="footer-middle">
				<h4>Browse</h4>
				<ul>
					<li ><a href="../..">Home</a></li>
					<li ><a href="../../download/">Downloads</a></li>
					<li ><a href="../../tutorials/getting-started.html">Tutorials</a></li>
					<li ><a href="../../docs/deepstream.html">Documentation</a></li>
					<li ><a href="../../blog/">Blog</a></li>
					<li class="active"><a href="../../info/">Info</a></li>
				</ul>			</li>

			<li class="footer-left">
				<h4>Contact us</h4>
				<p>
					<b>deepstream.io </b>is developed by Hoxton One Ltd. <br>
				</p>
				<p>
					Email us <a href="mailto:info@deepstream.io">info@deepstream.io</a>.<br><br>
				</p>

				<h4>Star this project on github!</h4>
				<p>
					<a class="github-button" href="https://github.com/hoxton-one/deepstream.io" data-icon="octicon-star" data-style="mega" data-count-href="/hoxton-one/deepstream.io/stargazers" data-count-api="/repos/hoxton-one/deepstream.io#stargazers_count" data-count-aria-label="# stargazers on GitHub" aria-label="Star hoxton-one/deepstream.io on GitHub">Star</a>
				</p>
			</li>

		</ul>
	</div>


	<script async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>
</body>
</html>
